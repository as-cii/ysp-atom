// Generated by CoffeeScript 1.12.0
(function() {
  var File, XibToolsHelper;

  File = require('atom').File;

  module.exports = XibToolsHelper = (function() {
    XibToolsHelper.prototype.propertyLabels = [];

    XibToolsHelper.prototype.classFlie = null;

    XibToolsHelper.prototype.xibFile = null;

    function XibToolsHelper(args) {}

    XibToolsHelper.prototype.openXib = function(filePath) {
      var editor, exec, file, fs, process, self;
      if (filePath == null) {
        editor = atom.workspace.getActivePaneItem();
        file = editor != null ? editor.buffer.file : void 0;
        filePath = file != null ? file.path : void 0;
      }
      process = require('child_process');
      exec = process.exec;
      exec('open "' + filePath + '"');
      fs = new File(filePath, false);
      self = this;
      return fs.onDidChange(function() {
        return fs.read().then(function(xmlString) {
          var xmlreader;
          xmlreader = require('xmlreader');
          return xmlreader.read(xmlString, function(errors, response) {
            var str;
            self.propertyLabels = [];
            self.className = filePath.split('/').pop().split('.')[0];
            str = filePath.split('.');
            str.pop();
            str.push(".js");
            str = str.join('');
            self.getPropertyLabelWithView(response.document.objects.view);
            return self.saveToJSClass(str, self.className, self.propertyLabels);
          });
        });
      });
    };

    XibToolsHelper.prototype.newXib = function() {
      var AddDialog, dialog, editor, file, filePath, self;
      AddDialog = require('./add-dialog');
      editor = atom.workspace.getActivePaneItem();
      file = editor != null ? editor.buffer.file : void 0;
      filePath = file != null ? file.path : void 0;
      if (!filePath) {
        filePath = "";
      }
      dialog = new AddDialog(filePath, true);
      self = this;
      dialog.on('file-created', function(event, createdPath) {
        return false;
      });
      return dialog.attach();
    };

    XibToolsHelper.prototype.getPropertyLabelWithView = function(view) {
      var i, len, ref, subview, subviews;
      if (view.array != null) {
        ref = view.array;
        for (i = 0, len = ref.length; i < len; i++) {
          subview = ref[i];
          this.getPropertyLabelWithView(subview);
        }
        return;
      }
      if ((view.attributes().userLabel != null) && view.attributes().userLabel.startsWith("@")) {
        this.propertyLabels.push(view.attributes().userLabel.replace("@", ""));
      }
      subviews = view.subviews;
      if (subviews != null) {
        if (subviews.button != null) {
          this.getPropertyLabelWithView(subviews.button);
        }
        if (subviews.label != null) {
          this.getPropertyLabelWithView(subviews.label);
        }
        if (subviews.view != null) {
          this.getPropertyLabelWithView(subviews.view);
        }
        if (subviews.tableView != null) {
          this.getPropertyLabelWithView(subviews.tableView);
        }
        if (subviews.imageView != null) {
          this.getPropertyLabelWithView(subviews.imageView);
        }
        if (subviews.textField != null) {
          this.getPropertyLabelWithView(subviews.textField);
        }
        if (subviews.webView != null) {
          return this.getPropertyLabelWithView(subviews.webView);
        }
      }
    };

    XibToolsHelper.prototype.saveToJSClass = function(filePath, className, propertyLabels) {
      var jsfs;
      jsfs = new File(filePath, false);
      return jsfs.exists().then(function(isExists) {
        var jsContent;
        if (isExists) {
          return jsfs.read().then(function(text) {
            var reg, str;
            reg = new RegExp('\(YYClass\\(.*\)\\[.*\\]', 'gi');
            str = text.replace(reg, "$1[" + propertyLabels + "]");
            return jsfs.writeSync(str);
          });
        } else {
          jsContent = "YYClass('" + className + ":YYXibUIView', [" + propertyLabels + "],{},{})";
          return jsfs.create().then(function(isCreated) {
            jsfs.writeSync(jsContent);
            return jsfs.read().then(function(text) {});
          });
        }
      });
    };

    return XibToolsHelper;

  })();

}).call(this);
